<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Production Management</title>
  <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore-compat.js"></script>
  <script>
    // Your Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyBfgw55oz008_Du9yGq8uWFes9hp2bG0nQ",
      authDomain: "productionmanagement-fd409.firebaseapp.com",
      projectId: "productionmanagement-fd409",
      storageBucket: "productionmanagement-fd409.appspot.com",
      messagingSenderId: "1093616249374",
      appId: "1:1093616249374:web:8a8b50821b1ac9ba4fdc0f"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // Login function
    function login() {
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      auth.signInWithEmailAndPassword(email, password)
        .then(() => {
          alert('Login successful');
          document.getElementById('loginForm').style.display = 'none';
          document.getElementById('homePage').style.display = 'block';
          loadTableData();
          loadWorkerData();
          startFinishingTimeUpdate();
        })
        .catch((error) => {
          alert('Error: ' + error.message);
        });
    }

    // Check authentication state
    auth.onAuthStateChanged((user) => {
	  if (user) {
		document.getElementById('loginForm').style.display = 'none';
		setPageDisplayBasedOnURL();
		loadTableData();
		loadWorkerData();
		startFinishingTimeUpdate();

		// Show admin controls if the user is the admin
		if (user.email === 'kumar@seaspire.com') {
		  document.getElementById('adminControls').style.display = 'block';
		} else {
		  document.getElementById('adminControls').style.display = 'none';
		}
	  } else {
		document.getElementById('loginForm').style.display = 'block';
		document.getElementById('homePage').style.display = 'none';
		document.getElementById('calculatePage').style.display = 'none';
	  }
	});

    // Load data from Firebase Realtime Database
	function loadTableData() {
	  const homeTableBody = document.querySelector('#dataTable tbody');
	  const calcTableBody = document.getElementById('calculationTableBody');
	  const lastUpdateElement = document.getElementById('lastUpdate');

	  db.collection('GRNs').onSnapshot((querySnapshot) => {
		homeTableBody.innerHTML = '';
		calcTableBody.innerHTML = '';

		if (!querySnapshot.empty) {
		  querySnapshot.forEach((doc) => {
			const item = doc.data();
			const daysElapsed = calculateDaysElapsed(item.receivingDate);

			// Populate the home page table
			const homeRow = document.createElement('tr');
			homeRow.innerHTML = `
			  <td title="${item.grnNo || ''}">${item.grnNo || ''}</td>
			  <td title="${item.species || ''}">${item.species || ''}</td>
			  <td title="${item.receivingDate || ''}">${item.receivingDate || ''}</td>
			  <td title="${daysElapsed}">${daysElapsed}</td>
			  <td title="${item.receivedQuantity || ''}">${item.receivedQuantity || ''}</td>
			  <td title="${item.remainingQuantity || ''}">${item.remainingQuantity || ''}</td>
			  <td title="${item.timeNeeded || ''}">${item.timeNeeded || ''}</td>
			`;
			homeTableBody.appendChild(homeRow);

			// Populate the calculation page table
			const calcRow = document.createElement('tr');
			calcRow.innerHTML = `
			  <td title="${item.grnNo || ''}">${item.grnNo || ''}</td>
			  <td title="${item.species || ''}">${item.species || ''}</td>
			  <td title="${item.receivingDate || ''}">${item.receivingDate || ''}</td>
			  <td title="${item.remainingQuantity || ''}">${item.remainingQuantity || ''}</td>
			  <td><input type="text" placeholder="Finishing Time" readonly></td>
			  <td><input type="date" placeholder="Expiration Date"></td>
			  <td>
				<button onclick="moveRowUp(this)">⬆️</button>
				<button onclick="moveRowDown(this)">⬇️</button>
			  </td>
			`;
			calcTableBody.appendChild(calcRow);
		  });
		  updateFinishingTimes();
		  // Call the new function to calculate time needed for finishing
			calculateTimeNeededForFinish(); // Add this line
		} else {
		  lastUpdateElement.textContent = 'No data available';
		}
	  }, (error) => {
		console.error('Error fetching data:', error);
		lastUpdateElement.textContent = 'Failed to load data';
	  });

	  db.collection('Workers').doc('Update').onSnapshot((doc) => {
		if (doc.exists) {
			const lastUpdatedValue = doc.data().lastUpdated;
			lastUpdateElement.textContent = `Last Update: ${formatTimestamp(lastUpdatedValue)}`;
		} else {
			lastUpdateElement.textContent = 'Last Update: No timestamp available';
		}
	});
	}

    // Load worker data
    function loadWorkerData() {
	  const workerCountElement = document.getElementById('workerCount');

	  // Listen for real-time updates to the w1 document in the Workers collection
	  db.collection('Workers').doc('w1').onSnapshot((doc) => {
		if (doc.exists) {
		  const count = doc.data().availableWorkers || 0;
		  workerCountElement.textContent = `Available Workers Today: ${count}`;
		  updateFinishingTimes();
		} else {
		  console.log('No such document!');
		  workerCountElement.textContent = 'Available Workers Today: 0';
		}
	  }, (error) => {
		console.error('Error fetching worker data:', error);
		workerCountElement.textContent = 'Failed to load worker data';
	  });
	}

    // Update Finishing Time for all rows
	function updateFinishingTimes() {
	  const rows = Array.from(document.getElementById('calculationTableBody').children);
	  let cumulativeTime = 0;

	  db.collection('Workers').doc('w1').get().then((doc) => {
		const availableWorkers = doc.exists ? parseFloat(doc.data().availableWorkers) || 0 : 0;

		// Get OT rows to calculate any overtime
		const otRows = Array.from(document.getElementById('otTableBody').children);
		const overtimeMap = new Map();
		otRows.forEach((otRow) => {
		  const otDate = otRow.querySelector('input[type="date"]').value;
		  const otHoursValue = parseFloat(otRow.querySelector('input[type="number"]').value);
		  if (otDate && !isNaN(otHoursValue)) {
			overtimeMap.set(otDate, otHoursValue);
		  }
		});

		rows.forEach((row) => {
		  const species = row.children[1].querySelector('input') ? row.children[1].querySelector('input').value : row.children[1].textContent.trim();
		  const receivingDateValue = row.children[2].querySelector('input') ? row.children[2].querySelector('input').value : row.children[2].textContent.trim();
		  const remainingQuantity = parseFloat(row.children[3].querySelector('input') ? row.children[3].querySelector('input').value : row.children[3].textContent.trim());
		  let manHoursRequired = 0;

		  if (isNaN(remainingQuantity)) {
			return;
		  }

		  // Calculate manHoursRequired based on species
		  if (species.toUpperCase() === 'SKIPJACK TUNA') {
			manHoursRequired = (remainingQuantity / 1423) * 35.25;
		  } else if (species.toUpperCase() === 'YELLOWFIN TUNA') {
			manHoursRequired = (remainingQuantity / 1000) * 10;
		  } else {
			// Handle unknown species or set default values
			return;
		  }

		  if (availableWorkers > 0) {
			let hoursRequired = manHoursRequired / availableWorkers;
			cumulativeTime += hoursRequired;

			// Calculate finishing time
			const finishingTimeInput = row.querySelector('input[placeholder="Finishing Time"]');
			let finishTime = new Date(); // Start from the current time

			let hoursToAdd = cumulativeTime;

			// Adjust for breaks upfront if necessary
			if (hoursToAdd > 4) {
			  hoursToAdd += 1; // Add 1 hour for lunch if over 4 hours
			}
			if (hoursToAdd > 12) {
			  hoursToAdd += 0.75; // Add 45 minutes for dinner if over 12 hours
			}

			while (hoursToAdd > 0) {
			  const currentHour = finishTime.getHours();
			  const currentDate = finishTime.toISOString().split('T')[0];
			  const overtimeHours = parseFloat(overtimeMap.get(currentDate) || 0);

			  // If before work hours, set to 8 AM
			  if (currentHour < 8) {
				finishTime.setHours(8, 0, 0, 0);
				continue;
			  }

			  // Calculate end of workday based on OT hours
			  let endOfWorkDay = new Date(finishTime);
			  let regularEndTimeMinutes = 16 * 60 + 30; // 16:30 in minutes
			  let otMinutes = overtimeHours * 60; // Convert OT hours to minutes
			  let totalEndTimeMinutes = regularEndTimeMinutes + otMinutes;

			  let endHour = Math.floor(totalEndTimeMinutes / 60);
			  let endMinute = totalEndTimeMinutes % 60;

			  // Set end of workday
			  endOfWorkDay.setHours(endHour, endMinute, 0, 0);

			  // If after work hours, move to next day at 8:00 AM
			  if (finishTime >= endOfWorkDay) {
				finishTime.setDate(finishTime.getDate() + 1);
				finishTime.setHours(8, 0, 0, 0);
				continue;
			  }

			  // Check if the calculated time falls within the lunch break (12 PM - 1 PM)
			  if (finishTime.getHours() === 12) {
				finishTime.setHours(13, 0, 0, 0);
				continue;
			  }

			  // Check if the calculated time falls within the dinner break (8 PM - 8:45 PM)
			  if (finishTime.getHours() === 20 && finishTime.getMinutes() < 45) {
				finishTime.setHours(20, 45, 0, 0);
				continue;
			  }

			  // Calculate remaining time in the current work period
			  let timeUntilEndOfWorkDay = (endOfWorkDay - finishTime) / (1000 * 60 * 60); // Time until end of workday in hours

			  if (hoursToAdd <= timeUntilEndOfWorkDay) {
				// If hours to add fit within the current work period
				finishTime.setTime(finishTime.getTime() + hoursToAdd * 60 * 60 * 1000);
				hoursToAdd = 0;
			  } else {
				// If hours to add exceed the current work period, move to end of day and continue
				finishTime = endOfWorkDay;
				hoursToAdd -= timeUntilEndOfWorkDay;
			  }
			}

			// Adjust if finishing time falls within the lunch or dinner breaks
			if (finishTime.getHours() === 12) {
			  finishTime.setHours(13, 0, 0, 0);
			}
			if (finishTime.getHours() === 20 && finishTime.getMinutes() < 45) {
			  finishTime.setHours(20, 45, 0, 0);
			}

			// Format the finishing time with date
			const dateOptions = {
			  year: 'numeric',
			  month: 'numeric',
			  day: 'numeric'
			};
			const formattedDate = finishTime.toLocaleDateString('en-US', dateOptions);

			let hours = finishTime.getHours();
			const minutes = finishTime.getMinutes().toString().padStart(2, '0');
			const ampm = hours >= 12 ? 'pm' : 'am';
			hours = hours % 12 || 12; // Convert to 12-hour format, ensuring 12 instead of 0
			finishingTimeInput.value = `${formattedDate}, ${hours}:${minutes} ${ampm}`;
			finishingTimeInput.title = finishingTimeInput.value; // Add tooltip

			// Calculate time elapsed between receiving date and finishing time
			const timeElapsedCell = row.children[5]; // Assuming the "TIME ELAPSED WHEN FINISH" column is the 6th column
			const receivingDate = new Date(receivingDateValue);
			const timeElapsed = Math.floor((finishTime - receivingDate) / (1000 * 60 * 60 * 24)); // Calculate the difference in days
			timeElapsedCell.textContent = timeElapsed >= 0 ? `${timeElapsed} days` : 'Invalid';
			timeElapsedCell.setAttribute('title', timeElapsedCell.textContent); // Add tooltip
		  }
		});
	  }).catch((error) => {
		console.error('Error fetching available workers:', error);
	  });
	}
	
	// Calculate Time Needed for Finish and display in the "TIME NEEDED FOR FINISH" column
	function calculateTimeNeededForFinish() {
	  const homeTableBody = document.querySelector('#dataTable tbody');
	  const rows = Array.from(homeTableBody.children);

	  // Use onSnapshot to listen for real-time updates to the availableWorkers field
	  db.collection('Workers').doc('w1').onSnapshot((doc) => {
		if (doc.exists) {
		  const availableWorkers = doc.data().availableWorkers || 1;

		  rows.forEach((row) => {
			const species = row.children[1].textContent;
			const remainingQuantity = parseFloat(row.children[5].textContent);

			if (isNaN(remainingQuantity) || remainingQuantity <= 0) {
			  row.children[6].textContent = 'Invalid Quantity';
			  row.children[6].setAttribute('title', 'Invalid Quantity'); // Add tooltip
			  return;
			}

			let manHoursRequired = 0;

			if (species === 'SKIPJACK TUNA') {
			  manHoursRequired = (remainingQuantity / 1423) * 35.25;
			} else if (species === 'YELLOWFIN TUNA') {
			  manHoursRequired = (remainingQuantity / 1000) * 10;
			} else {
			  row.children[6].textContent = 'Unknown Species';
			  row.children[6].setAttribute('title', 'Unknown Species'); // Add tooltip
			  return;
			}

			const timeNeededHours = manHoursRequired / availableWorkers;
			const totalMinutes = Math.round(timeNeededHours * 60);
			const hours = Math.floor(totalMinutes / 60);
			const minutes = totalMinutes % 60;

			row.children[6].textContent = `${hours > 0 ? hours + ' h ' : ''}${minutes} min`;
			row.children[6].setAttribute('title', row.children[6].textContent); // Add tooltip
		  });
		} else {
		  console.error("Document does not exist!");
		}
	  }, (error) => {
		console.error("Error fetching available workers:", error);
	  });
	}



	function calculateTimeElapsedWhenFinish() {
	  // Get all rows of the table with id="calculationTable"
	  const rows = Array.from(document.getElementById('calculationTableBody').children);

	  // Iterate through each row
	  rows.forEach((row) => {
		const receivingDateInput = row.children[2].querySelector('input');
		const finishingTimeInput = row.querySelector('input[placeholder="Finishing Time"]');
		const timeElapsedCell = row.children[5]; // Assuming this is the "TIME ELAPSED WHEN FINISH" column

		if (receivingDateInput && finishingTimeInput && timeElapsedCell) {
		  // Parse the receiving date from input
		  const receivingDate = new Date(receivingDateInput.value);
		  // Extract only the date part from finishing time
		  const finishingTimeValue = finishingTimeInput.value.split(", ")[0];
		  const [month, day, year] = finishingTimeValue.split('/').map(Number);
		  const finishingDate = new Date(year, month - 1, day);

		  // Set both dates to midnight for accurate day comparison
		  receivingDate.setHours(0, 0, 0, 0);
		  finishingDate.setHours(0, 0, 0, 0);

		  // Calculate the difference in milliseconds and convert to days
		  const timeDifference = finishingDate - receivingDate;
		  const daysElapsed = Math.ceil(timeDifference / (1000 * 60 * 60 * 24));

		  // Display the number of days elapsed
		  timeElapsedCell.textContent = daysElapsed >= 0 ? daysElapsed : 0;
		  timeElapsedCell.setAttribute('title', timeElapsedCell.textContent); // Add tooltip
		}
	  });
	}

    // Add available workers (Admin only)
    function addAvailableWorkers() {
      const user = auth.currentUser;
      if (user && user.email === 'kumar@seaspire.com') { // Replace with your admin email
        const workerCount = document.getElementById('workerInput').value;
        db.collection('Workers').doc('w1').set({ availableWorkers: workerCount }, { merge: true })
		  .then(() => {
			alert('Available workers updated successfully');
		  })
		  .catch((error) => {
			alert('Error updating workers: ' + error.message);
		  });
	  } else {
		alert('You do not have permission to perform this action');
	  }
	}
	
	function calculateDaysElapsed(receivingDate) {
	  const today = new Date();
	  const receivedDate = new Date(receivingDate);

	  // Set both dates to midnight to avoid time issues
	  today.setHours(0, 0, 0, 0);
	  receivedDate.setHours(0, 0, 0, 0);

	  // Calculate the difference in milliseconds, then convert to days
	  const timeDifference = today - receivedDate;
	  const daysElapsed = Math.ceil(timeDifference / (1000 * 60 * 60 * 24));

	  return daysElapsed >= 0 ? daysElapsed : 0;
	}

    function formatTimestamp(timestamp) {
      const options = {
        year: 'numeric',
        month: 'numeric',
        day: 'numeric',
        hour: 'numeric',
        minute: 'numeric',
        second: 'numeric',
        hour12: true
      };
      return new Date(timestamp).toLocaleString('en-US', options);
    }

    function logout() {
      auth.signOut().then(() => {
        alert('Logged out successfully');
        window.location.reload();
      }).catch((error) => {
        alert('Error logging out: ' + error.message);
      });
    }

    function showCalculatePage() {
	  console.log('Navigating to Calculate Page');
	  document.getElementById('homePage').style.display = 'none';
	  document.getElementById('calculatePage').style.display = 'block';
	}

	function showHomePage() {
	  console.log('Navigating to Home Page');
	  document.getElementById('calculatePage').style.display = 'none';
	  document.getElementById('homePage').style.display = 'block';
	}

    function addNewRow() {
      const tableBody = document.getElementById('calculationTableBody');
      const newRow = document.createElement('tr');
      newRow.innerHTML = `
        <td><input type="text" placeholder="GRN NO." style="width: 100%;"></td>
        <td><input type="text" placeholder="Species" style="width: 100%;"></td>
        <td><input type="date" style="width: 100%;"></td>
        <td><input type="text" placeholder="Remaining Quantity" style="width: 100%;"></td>
        <td><input type="text" placeholder="Finishing Time" readonly style="width: 100%;"></td>
        <td><input type="date" style="width: 100%;"></td>
        <td>
          <button onclick="moveRowUp(this)" style="width: 48%;">⬆️</button>
          <button onclick="moveRowDown(this)" style="width: 48%;">⬇️</button>
        </td>
      `;
      tableBody.appendChild(newRow);
      attachInputListeners(newRow);
      updateFinishingTimes();
	  calculateTimeElapsedWhenFinish(); // Add this line to update elapsed time after adding a new row
    }

    function moveRowUp(button) {
      const row = button.parentElement.parentElement;
      const previousRow = row.previousElementSibling;
      if (previousRow) {
        row.parentNode.insertBefore(row, previousRow);
        updateFinishingTimes();
      }
    }

    function moveRowDown(button) {
      const row = button.parentElement.parentElement;
      const nextRow = row.nextElementSibling;
      if (nextRow) {
        row.parentNode.insertBefore(nextRow, row);
        updateFinishingTimes();
      }
    }

    // Attach input listeners to dynamically update finishing times when data changes
    function attachInputListeners(row) {
      const inputs = row.querySelectorAll('input[type="text"], input[type="date"]');
      inputs.forEach(input => {
        input.addEventListener('input', () => {
          updateFinishingTimes();
        });
      });
    }

    // Add a new row to OT Consideration table
	function addNewOTRow() {
	  const tableBody = document.getElementById('otTableBody');
	  const newRow = document.createElement('tr');

	  // Calculate the new date
	  let newDate;
	  if (tableBody.children.length === 0) {
		// First row, use today's date
		newDate = new Date();
	  } else {
		// Get the date from the last row and add one day
		const lastRow = tableBody.children[tableBody.children.length - 1];
		const lastDateString = lastRow.querySelector('input[type="date"]').value;
		const lastDate = new Date(lastDateString);
		newDate = new Date(lastDate);
		newDate.setDate(newDate.getDate() + 1); // Add one day
	  }

	  // Format the new date as yyyy-mm-dd for the input field
	  const formattedDate = newDate.toISOString().split('T')[0];

	  newRow.innerHTML = `
		<td><input type="date" style="width: 100%;" value="${formattedDate}"></td>
		<td><input type="number" min="0" max="6" step="0.25" placeholder="OT Hours" style="width: 100%;"></td>
		<td>
		  <button onclick="deleteRow(this)" style="width: 100%;">🗑️</button>
		</td>
	  `;
	  tableBody.appendChild(newRow);

	  // Attach event listener to the OT hours input
	  const otHoursInput = newRow.querySelector('input[type="number"]');
	  otHoursInput.addEventListener('input', () => {
		let value = parseFloat(otHoursInput.value);
		if (value > 6) {
		  otHoursInput.value = 6;
		} else if (value < 0) {
		  otHoursInput.value = 0;
		}
		updateFinishingTimes(); // Trigger finishing time update after input change
	  });
	}

    // Add a new row to ICE Loading table
	function addNewIceLoadingRow() {
	  const tableBody = document.getElementById('iceLoadingTableBody');
	  const newRow = document.createElement('tr');
	  newRow.innerHTML = `
		<td><input type="date" style="width: 100%;"></td>
		<td><input type="text" placeholder="Ice Bag Qty" style="width: 100%;"></td>
		<td><input type="text" placeholder="Peoples" style="width: 100%;"></td>
		<td><input type="text" placeholder="Time Need" style="width: 100%;" readonly></td>
		<td>
		  <button onclick="deleteRow(this)" style="width: 100%;">🗑️</button>
		</td>
	  `;
	  tableBody.appendChild(newRow);

	  // Attach event listeners for real-time updates
	  const iceBagQtyInput = newRow.children[1].querySelector('input');
	  const peopleInput = newRow.children[2].querySelector('input');

	  iceBagQtyInput.addEventListener('input', updateIceLoadingTimes);
	  peopleInput.addEventListener('input', updateIceLoadingTimes);
	}

    // Add a new row to Other Works table
    function addNewOtherWorksRow() {
      const tableBody = document.getElementById('otherWorksTableBody');
      const newRow = document.createElement('tr');
      newRow.innerHTML = `
        <td><input type="date" style="width: 100%;"></td>
        <td><input type="text" placeholder="Time Need" style="width: 100%;"></td>
        <td><input type="text" placeholder="Peoples" style="width: 100%;"></td>
        <td>
          <button onclick="deleteRow(this)" style="width: 100%;">🗑️</button>
        </td>
      `;
      tableBody.appendChild(newRow);
    }

    // Delete a row from any table
    function deleteRow(button) {
      const row = button.parentElement.parentElement;
      row.remove();
      updateFinishingTimes();
    }

    // Start interval to update finishing times every minute
	function startFinishingTimeUpdate() {
	  setInterval(() => {
		const rows = Array.from(document.getElementById('calculationTableBody').children);

		// Get OT rows to calculate any overtime
		const otRows = Array.from(document.getElementById('otTableBody').children);
		const overtimeMap = new Map();
		otRows.forEach((otRow) => {
		  const otDate = otRow.querySelector('input[type="date"]').value;
		  const otHoursValue = parseFloat(otRow.querySelector('input[type="number"]').value);
		  if (otDate && otHoursValue) {
			overtimeMap.set(otDate, otHoursValue);
		  }
		});

		rows.forEach((row) => {
		  const finishingTimeInput = row.querySelector('input[placeholder="Finishing Time"]');
		  if (finishingTimeInput && finishingTimeInput.value) {
			// Parse existing finishing time to Date object
			const [datePart, timePart] = finishingTimeInput.value.split(', ');
			const [month, day, year] = datePart.split('/').map(Number);
			const [time, ampm] = timePart.split(/(am|pm)/);
			let [hours, minutes] = time.split(':').map(Number);
			if (ampm.trim() === 'pm' && hours !== 12) {
			  hours += 12;
			} else if (ampm.trim() === 'am' && hours === 12) {
			  hours = 0;
			}

			// Create a Date object and add 1 minute
			let finishTime = new Date(year, month - 1, day, hours, minutes);
			finishTime.setMinutes(finishTime.getMinutes() + 1);

			// Adjust for lunch break (12 PM - 1 PM)
			if (finishTime.getHours() >= 12 && finishTime.getHours() < 13) {
			  finishTime.setHours(13, finishTime.getMinutes(), 0, 0);
			}

			// Adjust for dinner break (8 PM - 8:45 PM)
			if (finishTime.getHours() >= 20 && finishTime.getMinutes() < 45) {
			  finishTime.setHours(20, 45, 0, 0);
			}

			// Determine end of workday based on OT hours
			const currentDate = finishTime.toISOString().split('T')[0];
			const overtimeHours = overtimeMap.get(currentDate) || 0;
			const endHour = 16 + overtimeHours;
			const endMinute = 30;

			// Adjust for after work hours (4:30 PM + OT) - move to the next session or next working day
			if (finishTime.getHours() > endHour || (finishTime.getHours() === endHour && finishTime.getMinutes() >= endMinute)) {
			  finishTime.setDate(finishTime.getDate() + 1);
			  finishTime.setHours(8, 0, 0, 0);
			}

			// Format the updated time
			const dateOptions = {
			  year: 'numeric',
			  month: 'numeric',
			  day: 'numeric'
			};
			const formattedDate = finishTime.toLocaleDateString('en-US', dateOptions);

			let updatedHours = finishTime.getHours();
			const updatedMinutes = finishTime.getMinutes().toString().padStart(2, '0');
			const updatedAmpm = updatedHours >= 12 ? 'pm' : 'am';
			updatedHours = updatedHours % 12 || 12; // Convert to 12-hour format, ensuring 12 instead of 0

			// Update the input field with the new value
			finishingTimeInput.value = `${formattedDate}, ${updatedHours}:${updatedMinutes} ${updatedAmpm}`;
			finishingTimeInput.title = finishingTimeInput.value; // Add tooltip
		  }
		});
	  }, 60000); // Update every minute
	}

	// Function to calculate time needed for ice loading based on ice bags and people involved
	function updateIceLoadingTimes() {
	  const rows = Array.from(document.getElementById('iceLoadingTableBody').children);
	  rows.forEach((row) => {
		const iceBagQtyInput = row.children[1].querySelector('input');
		const peopleInput = row.children[2].querySelector('input');
		const timeNeedInput = row.children[3].querySelector('input');

		const iceBagQty = parseInt(iceBagQtyInput.value, 10);
		const peopleCount = parseInt(peopleInput.value, 10);

		if (!isNaN(iceBagQty) && !isNaN(peopleCount) && peopleCount > 0) {
		  // Calculation for time needed: (20/35) * 4 * iceBagQty / peopleCount
		  const totalTime = (20 / 35) * 4 * iceBagQty / peopleCount;
		  const hours = Math.floor(totalTime / 60);
		  const minutes = Math.floor(totalTime % 60);
		  timeNeedInput.value = `${hours > 0 ? hours + ' hr ' : ''}${minutes} min`;
		} else {
		  timeNeedInput.value = '';
		}
	  });
	}
	
	// Function to update the lastUpdated value in the database (Admin only)
	function updateLastUpdated() {
	  const user = auth.currentUser;
	  if (user && user.email === 'kumar@seaspire.com') { // Replace with your admin email
		const currentTime = new Date().toISOString(); // Get current date and time in ISO format
		 db.collection('Workers').doc('Update').set({ lastUpdated: currentTime }, { merge: true })
		  .then(() => {
			alert('Last updated timestamp has been successfully updated.');
			document.getElementById('lastUpdate').textContent = `Last Update: ${formatTimestamp(currentTime)}`;
		  })
		  .catch((error) => {
			alert('Error updating timestamp: ' + error.message);
		  });
	  } else {
		alert('You do not have permission to perform this action');
	  }
	}
	
	window.onload = function() {
	  console.log('Page Loaded');
	  setPageDisplayBasedOnURL();
	};
	
	function setPageDisplayBasedOnURL() {
	  if (window.location.hash === '#calculatePage') {
		showCalculatePage();
	  } else {
		showHomePage();
	  }
	}

	// Update function to attach event listeners for real-time calculation
	function addNewIceLoadingRow() {
	  const tableBody = document.getElementById('iceLoadingTableBody');
	  const newRow = document.createElement('tr');
	  newRow.innerHTML = `
		<td><input type="date" style="width: 100%;"></td>
		<td><input type="text" placeholder="Ice Bag Qty" style="width: 100%;"></td>
		<td><input type="text" placeholder="Peoples" style="width: 100%;"></td>
		<td><input type="text" placeholder="Time Need" style="width: 100%;" readonly></td>
		<td>
		  <button onclick="deleteRow(this)" style="width: 100%;">🗑️</button>
		</td>
	  `;
	  tableBody.appendChild(newRow);

	  // Attach event listeners for real-time updates
	  const iceBagQtyInput = newRow.children[1].querySelector('input');
	  const peopleInput = newRow.children[2].querySelector('input');

	  iceBagQtyInput.addEventListener('input', updateIceLoadingTimes);
	  peopleInput.addEventListener('input', updateIceLoadingTimes);
	}

	// Call updateIceLoadingTimes periodically or after any significant change
	setInterval(updateIceLoadingTimes, 60000); // Update every minute to keep times accurate

  </script>
  <style>
	body {
		font-family: Arial, sans-serif;
		margin: 0;
		padding: 0;
		box-sizing: border-box;
		font-size: 100%; /* Base font size (16px) */
	}

	#homePage, #loginForm {
		margin: 20px auto;
		max-width: 95%;
	}

	#loginForm {
		text-align: center;
		background-color: #f9f9f9;
		padding: 1.25rem; /* 20px */
		border-radius: 8px;
		box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
		max-width: 400px;
	}

	#loginForm h2 {
		margin-bottom: 1.25rem; /* 20px */
	}

	#loginForm input {
		display: block;
		margin: 0.625rem auto; /* 10px */
		padding: 0.625rem; /* 10px */
		width: 80%;
		max-width: 300px;
		border: 1px solid #ccc;
		border-radius: 5px;
	}

	#loginForm button {
		background-color: #6c49b8;
		color: #fff;
		padding: 0.625rem; /* 10px */
		border: none;
		border-radius: 5px;
		cursor: pointer;
		width: 50%;
	}

	#loginForm button:hover {
		background-color: #5a3f9d;
	}

	nav {
		background-color: #6c49b8;
		color: #fff;
		padding: 0.625rem; /* 10px */
		display: flex;
		flex-wrap: wrap;
		justify-content: space-between;
		align-items: center;
	}

	nav h1 {
		margin: 0;
		font-size: 1.5rem; /* 24px */
	}

	nav a {
		color: #fff;
		text-decoration: none;
		margin: 0 0.625rem; /* 10px */
		font-weight: bold;
		font-size: 0.875rem; /* 14px */
	}

	nav button {
		background-color: #28a745;
		color: #fff;
		border: none;
		padding: 0.3125rem 0.625rem; /* 5px 10px */
		border-radius: 5px;
		cursor: pointer;
		font-size: 0.875rem; /* 14px */
	}

	.content {
		padding: 1.25rem; /* 20px */
		text-align: center;
	}

	.table-label {
		text-align: left;
		font-weight: bold;
		margin-bottom: 0.625rem; /* 10px */
		font-size: 1.125rem; /* 18px */
	}

	table {
		width: 100%;
		border-collapse: collapse;
		margin: 1.25rem 0; /* 20px */
		table-layout: fixed;
		overflow-x: auto;
	}

	th, td {
		border: 1px solid #ccc;
		padding: 0.5rem; /* 8px */
		text-align: center;
		white-space: nowrap; /* Prevent text from wrapping */
		overflow: hidden; /* Hide overflow */
		text-overflow: ellipsis; /* Add ellipsis for overflow */
		font-size: 1rem; /* Default font size (16px) */
	}

	th {
		background-color: #6c49b8;
		color: #fff;
	}

	input[type="text"], input[type="date"], input[type="number"] {
		box-sizing: border-box;
		font-size: 1rem;
		padding: 0.5rem;
		width: 100%;
	}

	button {
		box-sizing: border-box;
		padding: 0.5rem;
		font-size: 1rem;
		width: auto;
	}

	.calculate-btn {
		background-color: #00ff00;
		color: #000;
		border: 2px solid #00ff00;
		padding: 0.625rem; /* 10px */
		text-transform: uppercase;
		cursor: pointer;
		border-radius: 5px;
		margin-top: 1.25rem; /* 20px */
		font-size: 1rem;
	}

	.additional-tables-grid {
		display: grid;
		grid-template-columns: repeat(3, 1fr);
		gap: 1.25rem;         /* 20px */
		margin-top: 1.25rem;  /* 20px */
	}

	.table-container {
		text-align: center;
		font-size: 1rem;      /* 16px */
	}

	.add-row-btn {
		margin-top: 0.625rem; /* 10px */
	}

	.worker-count {
		position: absolute;
		top: 50px;
		right: 10px;
		background-color: #ffcc00;
		color: #000000;
		padding: 0.625rem;    /* 10px */
		border-radius: 5px;
		font-weight: bold;
		font-size: 0.875rem;  /* 14px */
	}

	/* Responsive adjustments */

	/* Larger screens (769px and above) */
	@media only screen and (min-width: 769px) {
		input[type="text"], input[type="date"], input[type="number"] {
			font-size: 1rem;
			padding: 0.5rem;
		}
		.calculate-btn, button {
			padding: 0.625rem; /* Restore previous padding */
			font-size: 1rem; /* Restore previous font size */
		}
	}

	/* Screens 768px and smaller */
	@media only screen and (max-width: 768px) {
		body {
			font-size: 87.5%; /* Base font size reduced to 14px */
		}
		nav h1 {
			font-size: 1.25rem; /* 20px */
		}
		nav a, nav button {
			margin: 0.3125rem; /* 5px */
			padding: 0.3125rem; /* 5px */
			font-size: 0.75rem; /* 12px */
		}
		nav div {
			display: flex;
			flex-direction: column;
			align-items: flex-start;
			width: 100%;
		}
		nav a, nav button {
			margin: 0.3125rem 0;
		}
		table {
			font-size: 0.35rem; /* Reduced font size for smaller screens */
		}
		th, td {
			font-size: 0.35rem;
			padding: 0.15rem;
		}
		input[type="text"], input[type="date"], input[type="number"], button {
			font-size: 0.35rem;
			padding: 0.15rem;
		}
		.content {
			padding: 0.3125rem;
		}
		.calculate-btn {
			padding: 0.5rem;
			font-size: 0.75rem;
		}
		.additional-tables-grid {
			grid-template-columns: 1fr;
		}
		.worker-count {
			position: static;
			margin-top: 0.625rem;
			align-self: center;
		}
		.table-label {
			font-size: 1rem;
		}
		.add-row-btn {
			font-size: 0.75rem;
			padding: 0.5rem;
		}
	}

	/* Screens 480px and smaller */
	@media only screen and (max-width: 480px) {
		table {
			font-size: 0.3rem; /* Reduced font size for very small screens */
		}
		th, td {
			font-size: 0.3rem;
			padding: 0.1rem;
		}
		input[type="text"], input[type="date"], input[type="number"], button {
			font-size: 0.3rem;
			padding: 0.1rem;
		}
		.calculate-btn {
			font-size: 0.6rem;
			padding: 0.3rem;
		}
		.add-row-btn {
			font-size: 0.6rem;
			padding: 0.3rem;
		}
		nav h1 {
			font-size: 1rem;
		}
		.table-label {
			font-size: 0.875rem;
		}
	}
  </style>
</head>
<body>
  <div id="loginForm">
    <h2>Login</h2>
    <input type="email" id="email" placeholder="Email" required>
    <input type="password" id="password" placeholder="Password" required>
    <button onclick="login()">Login</button>
  </div>

  <div id="homePage" style="display: none;">
    <nav>
      <h1>Home Page</h1>
      <div>
        <a href="stock.html">DOWNLOADS</a>
        <a href="#">TODAY PLAN</a>
        <a href="#">DAILY REPORT</a>
        <button onclick="logout()">Logout</button>
      </div>
    </nav>
    <div class="content">
      <div id="lastUpdate">Last Update: Loading...</div>
      <div class="table-label">Current Raw Material Stock</div>
      <table id="dataTable">
        <thead>
          <tr>
            <th>GRN NO.</th>
            <th>SPECIES</th>
            <th>RECEIVING DATE</th>
            <th>DAYS ELAPSED</th>
            <th>RECEIVED QUANTITY</th>
            <th>REMAINING QUANTITY</th>
            <th>TIME NEEDED FOR FINISH</th>
          </tr>
        </thead>
        <tbody>
          <!-- Rows will be dynamically added here -->
        </tbody>
      </table>
      <button class="calculate-btn" onclick="showCalculatePage()">Click here for calculate finishing date</button>
      <div id="adminControls" style="display: none;">
        <input type="number" id="workerInput" placeholder="Number of workers" style="width: 200px;">
        <button onclick="addAvailableWorkers()">Update Available Workers</button>
		<button onclick="updateLastUpdated()">UPDATE</button>
      </div>
    </div>
  </div>

  <div id="calculatePage" style="display: none;">
    <nav>
      <h1>Calculate</h1>
      <label id="workerCount" class="worker-count">Available Workers Today: Loading...</label>
      <div>
        <a href="javascript:void(0);" onclick="showHomePage()">HOME PAGE</a>
        <a href="stock.html">DOWNLOADS</a>
        <a href="#">TODAY PLAN</a>
        <a href="#">DAILY REPORT</a>
        <button onclick="logout()">Logout</button>
      </div>
    </nav>
    <div class="content">
      <h2>Calculation Page</h2>
      <!-- Existing Table -->
      <div class="table-container">
        <table id="calculationTable">
          <thead>
            <tr>
              <th>GRN NO.</th>
              <th>SPECIES</th>
              <th>RECEIVING DATE</th>
              <th>REMAINING QUANTITY</th>
              <th>FINISHING TIME</th>
              <th>TIME ELAPSED WHEN FINISH</th>
              <th>ACTIONS</th>
            </tr>
          </thead>
          <tbody id="calculationTableBody">
            <!-- Rows will be dynamically added here -->
          </tbody>
        </table>
        <button class="add-row-btn" onclick="addNewRow()">Add New Row</button>
      </div>

      <!-- Grid layout for additional tables -->
      <div class="additional-tables-grid">
        <!-- OT Consideration Table -->
        <div class="table-container">
          <h3>OT CONSIDERATION</h3>
          <table id="otTable">
            <thead>
              <tr>
                <th>DATE</th>
                <th>OT HOURS</th>
                <th>ACTIONS</th>
              </tr>
            </thead>
            <tbody id="otTableBody">
              <!-- Rows will be dynamically added here -->
            </tbody>
          </table>
          <button class="add-row-btn" onclick="addNewOTRow()">Add New Row</button>
        </div>

        <!-- ICE Loading Table -->
        <div class="table-container">
          <h3>ICE LOADING</h3>
          <table id="iceLoadingTable">
            <thead>
              <tr>
                <th>DATE</th>
                <th>ICE BAG QTY</th>
                <th>PEOPLES</th>
                <th>TIME NEED</th>
                <th>ACTIONS</th>
              </tr>
            </thead>
            <tbody id="iceLoadingTableBody">
              <!-- Rows will be dynamically added here -->
            </tbody>
          </table>
          <button class="add-row-btn" onclick="addNewIceLoadingRow()">Add New Row</button>
        </div>

        <!-- Other Works Table -->
        <div class="table-container">
          <h3>OTHER WORKS</h3>
          <table id="otherWorksTable">
            <thead>
              <tr>
                <th>DATE</th>
                <th>TIME NEED</th>
                <th>PEOPLES</th>
                <th>ACTIONS</th>
              </tr>
            </thead>
            <tbody id="otherWorksTableBody">
              <!-- Rows will be dynamically added here -->
            </tbody>
          </table>
          <button class="add-row-btn" onclick="addNewOtherWorksRow()">Add New Row</button>
        </div>
      </div>
    </div>
  </div>
</body>
</html>
